name: ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë° ìë™ ì¬ë°°í¬

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'ê°•ì œ ì¬ë°°í¬ ì‹¤í–‰'
        required: false
        default: false
        type: boolean
  
  # GitHub Actions ì‹¤í–‰ ì™„ë£Œ í›„
  workflow_run:
    workflows: ["pages", "deploy"]
    types: [completed]
  
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ 10ë¶„ë§ˆë‹¤)
  schedule:
    - cron: '*/10 * * * *'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        id: check_deployment
        run: |
          echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # í˜„ì¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì¬ë°°í¬
          if [ "${{ github.event.workflow_run.conclusion }}" = "failure" ]; then
            echo "âŒ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ë¨"
            echo "has_error=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… ë°°í¬ ìƒíƒœ ì •ìƒ"
            echo "has_error=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ìë™ ì¬ë°°í¬ ì‹¤í–‰
        if: steps.check_deployment.outputs.has_error == 'true' || github.event.inputs.force_redeploy == 'true'
        run: |
          echo "ğŸ”„ ìë™ ì¬ë°°í¬ ì‹œì‘..."
          
          # Git ì„¤ì •
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë¹ˆ ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ íŠ¸ë¦¬ê±°
          git commit --allow-empty -m "fix: ìë™ ì¬ë°°í¬ - ë°°í¬ ì˜¤ë¥˜ ìˆ˜ì • ($(date '+%Y-%m-%d %H:%M:%S'))"
          git push origin main
          
          echo "âœ… ìë™ ì¬ë°°í¬ ì™„ë£Œ!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ì¬ë°°í¬ í›„ ìƒíƒœ í™•ì¸
        if: steps.check_deployment.outputs.has_error == 'true' || github.event.inputs.force_redeploy == 'true'
        run: |
          echo "â° 30ì´ˆ ëŒ€ê¸° í›„ ì¬ë°°í¬ ìƒíƒœ í™•ì¸..."
          sleep 30
          
          echo "ğŸ” ì¬ë°°í¬ í›„ ìƒíƒœ í™•ì¸ ì¤‘..."
          npm run check-deployment
      
      - name: ì•Œë¦¼ ì „ì†¡ (ì„ íƒì‚¬í•­)
        if: always()
        run: |
          if [ "${{ steps.check_deployment.outputs.has_error }}" = "true" ]; then
            echo "âŒ ë°°í¬ ì˜¤ë¥˜ê°€ ê°ì§€ë˜ì–´ ìë™ ì¬ë°°í¬ë¥¼ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… ë°°í¬ ìƒíƒœê°€ ì •ìƒì…ë‹ˆë‹¤."
          fi
